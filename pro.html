<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I. New 2.0 Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        /* General Styling & THEME VARIABLES */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        :root {
            /* Light Theme (Default) */
            --app-bg: #f0f2f5;
            --primary-gradient: linear-gradient(135deg, #a5b4fc, #6366f1);
            --btn-primary: #8b5cf6;
            --btn-secondary: #ec4899;
            --btn-danger: #ef4444;
            --user-msg-bg: #8b5cf6;
            --ai-msg-bg: #ffffff;
            --header-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --input-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --sidebar-bg: #ffffff;
            --modal-bg: #ffffff;
            --code-bg: #1e293b;
        }
        body.dark-theme {
            /* Dark Theme */
            --app-bg: #121212;
            --btn-primary: #a78bfa;
            --user-msg-bg: #7c3aed;
            --ai-msg-bg: #2d2d2d;
            --header-bg: #1e1e1e;
            --card-bg: rgba(30, 30, 30, 0.95);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --input-bg: #374151;
            --border-color: #4b5563;
            --sidebar-bg: #1e1e1e;
            --modal-bg: #2d2d2d;
            --code-bg: #0f172a;
        }
        html, body { height: 100%; overflow: hidden; background-color: var(--app-bg); color: var(--text-primary); }
        body.menu-open { overflow: hidden; }

        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow-y: auto; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .view.active { display: flex; flex-direction: column; opacity: 1; }
        
        /* Loading Screen */
        #loading-view { background: var(--primary-gradient); color: white; justify-content: center; align-items: center; text-align: center; z-index: 9999; }
        .loading-content .logo { background: white; color: var(--btn-primary); }
        .loading-title { font-size: 24px; font-weight: 700; margin-top: 15px; }
        .loading-subtitle { font-size: 16px; font-weight: 400; margin-bottom: 30px; opacity: 0.8; }
        .loading-spinner { width: 32px; height: 32px; border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login/Register Page */
        #login-view, #register-view { background: var(--primary-gradient); justify-content: center; align-items: center; }
        .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 24px; padding: 40px 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 450px; margin: 20px; }
        .logo { width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #8b5cf6, #ec4899); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 28px; font-weight: 800; }
        .title { text-align: center; font-size: 28px; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
        .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 16px; }
        .form-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); font-weight: 600; }
        input { width: 100%; padding: 14px 45px 14px 18px; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; color: var(--text-primary); }
        input:focus { outline: none; border-color: var(--btn-primary); }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(10%); cursor: pointer; color: var(--text-secondary); }
        .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; border: none; color: white; background: var(--btn-primary); }
        .footer-text { text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-secondary); }
        .link { color: var(--btn-primary); cursor: pointer; font-weight: 700; }
        .error-message { color: var(--btn-danger); text-align: center; margin-top: 15px; min-height: 20px; font-weight: 600; }
        
        /* Mobile-First Chat UI */
        #chat-view { background: var(--app-bg); padding: 0; }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #chat-view .app-container { padding-bottom: 15px; }
        .app-header { display: flex; align-items: center; padding: 10px 15px; background: var(--header-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .menu-btn, .back-btn { background: none; border: none; cursor: pointer; padding: 8px; }
        .menu-btn .material-symbols-outlined, .back-btn .material-symbols-outlined { font-size: 28px; color: var(--text-primary); }
        .header-title { flex-grow: 1; text-align: center; font-size: 16px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Sidebar Menu */
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--sidebar-bg); box-shadow: 4px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1001; display: flex; flex-direction: column; padding: 20px; }
        .sidebar-header { padding: 20px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; text-align: center;}
        .sidebar-header .logo { margin: 0 auto 10px; }
        .brand-text { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .model-badge { font-size: 12px; color: var(--text-secondary); }
        .sidebar nav a { display: flex; align-items: center; padding: 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary); font-weight: 600; margin-bottom: 10px; transition: background-color 0.2s; }
        .sidebar nav a:hover { background-color: var(--app-bg); }
        .sidebar nav a .material-symbols-outlined { margin-right: 15px; }
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .sidebar-footer a { color: var(--text-secondary); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.menu-open .sidebar { transform: translateX(0); }
        body.menu-open .overlay { opacity: 1; visibility: visible; }

        /* Chat Messages */
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; font-size: 15px; animation: fadeIn 0.4s ease-out; }
        .user-message { background: var(--user-msg-bg); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background: var(--ai-msg-bg); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-content img { max-width: 100%; border-radius: 12px; margin-top: 8px; }
        .chat-loading-indicator { align-self: flex-start; display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-secondary); padding: 10px 15px; }
        .spinner { width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: var(--btn-primary); animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Code Block Styling */
        .code-block { background: var(--code-bg); border-radius: 12px; margin-top: 10px; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 15px; }
        .code-lang { color: #cbd5e1; font-size: 14px; font-weight: bold; text-transform: capitalize; }
        .copy-code-btn { background: #4a5568; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .code-block pre { margin: 0; padding: 15px; overflow-x: auto; }
        .code-block code { font-family: 'Courier New', Courier, monospace; color: #e2e8f0; font-size: 14px; white-space: pre; }

        /* Chat Input */
        .chat-input-container { padding: 15px; padding-top: 0; background: transparent; flex-shrink: 0; }
        .input-group { display: flex; gap: 10px; align-items: center; padding: 8px; background-color: var(--header-bg); border-radius: 34px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);}
        .chat-input { flex: 1; padding: 12px 18px; border: none; background-color: transparent; color: var(--text-primary); border-radius: 28px; font-size: 17px; resize: none; max-height: 150px; }
        .chat-input:focus { outline: none; }
        .action-btn { padding: 12px; border-radius: 50%; width: 48px; height: 48px; flex-shrink: 0; background: var(--btn-primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn .material-symbols-outlined { font-size: 24px; }
        
        /* Image Preview in Input Area */
        .image-preview-container { position: relative; width: 70px; height: 70px; margin-bottom: 10px; }
        #image-preview-thumbnail { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; border: 2px solid #ddd; }
        #remove-image-btn { position: absolute; top: -8px; right: -8px; background: black; color: white; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; cursor: pointer; font-size: 16px; line-height: 20px; text-align: center; }

        /* History & Contact Pages */
        #history-view, #contact-view, #calculator-view { background: var(--app-bg); padding: 0; }
        .page-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .history-item { background: var(--header-bg); border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-actions button { background: var(--input-bg); color: var(--text-primary); }
        
        /* Calculator Page */
        .calculator-wrapper { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px; }
        .calculator-display-container { width: 100%; background: var(--input-bg); color: var(--text-primary); padding: 20px; text-align: right; border-radius: 12px; margin-bottom: 20px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        .calculator-expression { font-size: 20px; color: var(--text-secondary); min-height: 24px; }
        .calculator-current-input { font-size: 48px; font-weight: 700; overflow-x: auto; white-space: nowrap; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .calc-btn { height: 70px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; background: var(--header-bg); color: var(--text-primary); transition: background-color 0.2s; }
        .calc-btn:hover { background-color: var(--input-bg); }
        .calc-btn.operator { color: var(--btn-primary); font-weight: bold; }
        .calc-btn.equals { background: var(--btn-primary); color: white; grid-column: 4; grid-row: 4 / 6; height: auto; border-radius: 40px; }
        .calc-btn.zero { grid-column: 1 / 3; border-radius: 40px; }
        .ai-calculator-section { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .ai-calculator-result { margin-top: 15px; padding: 15px; background: var(--header-bg); border-radius: 12px; min-height: 50px; line-height: 1.6; }

        /* Contact Page (Full Page) */
        #contact-view .app-container { justify-content: center; text-align: center; }
        .contact-title-large { font-size: 48px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary); }
        .contact-subtitle { font-size: 18px; color: var(--text-secondary); margin-bottom: 40px; }
        .contact-socials-large { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .contact-socials-large .btn { width: auto; padding: 15px 30px; font-size: 18px; }
        .contact-info-large p { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-content { background: var(--modal-bg); border-radius: 16px; padding: 25px; max-width: 500px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: zoomIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h2 { color: var(--text-primary); }
        .modal-body { color: var(--text-primary); }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app-root"></div>

    <script>
    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        const appRoot = document.getElementById('app-root');
        appRoot.innerHTML = `
            <div id="loading-view" class="view active">
                <div class="loading-content">
                    <div class="logo">PI</div>
                    <h1 class="loading-title">P.I. New 2.0 Pro</h1>
                    <p class="loading-subtitle">By Paong</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="sidebar" id="sidebar-menu">
                <div class="sidebar-header">
                    <div class="logo">PI</div>
                    <div class="brand-text">P.I. New</div>
                    <div class="model-badge">2.0 Pro</div>
                </div>
                <nav>
                    <a href="#" id="menu-new-chat-btn"><span class="material-symbols-outlined">add</span>Chat Baru</a>
                    <a href="#" id="menu-history-btn"><span class="material-symbols-outlined">history</span>Riwayat</a>
                    <a href="#" id="menu-calculator-btn"><span class="material-symbols-outlined">calculate</span>Kalkulator</a>
                    <a href="#" id="menu-contact-btn"><span class="material-symbols-outlined">contact_support</span>Kontak</a>
                </nav>
                <div class="sidebar-footer">
                    <a href="#" id="theme-toggle-btn"><span class="material-symbols-outlined">contrast</span>Ganti Tema</a>
                    <a href="#" id="menu-logout-btn"><span class="material-symbols-outlined">logout</span>Logout</a>
                </div>
            </div>
            <div class="overlay" id="overlay"></div>
            <div id="modal" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title"></h2>
                        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
                    </div>
                    <div id="modal-body" class="modal-body"></div>
                    <div id="modal-footer" style="margin-top: 20px; text-align: right;"></div>
                </div>
            </div>
            <div id="login-view" class="view">
                <div class="card">
                    <div class="logo">PI</div>
                    <h1 class="title">Selamat Datang</h1>
                    <div class="subtitle">Login untuk melanjutkan</div>
                    <form id="login-form">
                        <div class="form-group"><label for="login-username">Username</label><input type="text" id="login-username" required></div>
                        <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <button type="submit" class="btn">Login</button>
                        <div class="footer-text">Belum punya akun? <span class="link" id="go-to-register-btn">Daftar</span></div>
                    </form>
                    <div id="login-error" class="error-message"></div>
                </div>
            </div>
            <div id="register-view" class="view">
                <div class="card">
                    <div class="logo">PI</div>
                    <h1 class="title">Buat Akun Baru</h1>
                    <form id="register-form">
                        <div class="form-group"><label for="register-username">Username</label><input type="text" id="register-username" required></div>
                        <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <div class="form-group"><label for="register-confirm">Konfirmasi Password</label><input type="password" id="register-confirm" required><span class="material-symbols-outlined password-toggle">visibility_off</span></div>
                        <button type="submit" class="btn btn-secondary">Daftar</button>
                        <div class="footer-text">Sudah punya akun? <span class="link" id="go-to-login-btn">Login</span></div>
                    </form>
                    <div id="register-error" class="error-message"></div>
                </div>
            </div>
            <div id="chat-view" class="view">
                <div class="app-container">
                    <header class="app-header">
                        <button class="menu-btn" id="hamburger-btn"><span class="material-symbols-outlined">menu</span></button>
                        <div class="header-title" id="chat-title">P.I. New</div>
                        <div style="width: 44px;"></div> <!-- Spacer -->
                    </header>
                    <main class="chat-messages" id="chat-messages"></main>
                    <footer class="chat-input-container">
                        <div id="image-preview-container" class="image-preview-container" style="display: none;">
                            <img id="image-preview-thumbnail" src="" alt="Image preview"/>
                            <button id="remove-image-btn" class="remove-image-btn">&times;</button>
                        </div>
                        <div class="input-group">
                            <button id="upload-btn" class="action-btn" title="Unggah gambar"><span class="material-symbols-outlined">add_photo_alternate</span></button>
                            <textarea id="chat-input" class="chat-input" placeholder="Ketik pesan..." rows="1"></textarea>
                            <button id="send-btn" class="action-btn" title="Kirim"><span class="material-symbols-outlined">send</span></button>
                        </div>
                        <input type="file" id="file-input" accept="image/*" style="display: none">
                    </footer>
                </div>
            </div>
            <div id="history-view" class="view">
                <div class="app-container" style="padding: 20px;">
                    <header class="app-header" style="position: static; margin-bottom: 20px;">
                        <button class="back-btn" id="back-to-chat-from-history"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Riwayat Percakapan</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div id="history-list" style="width: 100%;"></div>
                </div>
            </div>
            <div id="contact-view" class="view">
                <div class="app-container" style="padding: 20px;">
                     <header class="app-header" style="position: static; margin-bottom: 20px;">
                        <button class="back-btn" id="back-to-chat-from-contact"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Kontak</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div class="contact-fullpage-container">
                        <h1 class="contact-title-large">P.I. New by Paong</h1>
                        <p class="contact-subtitle">Terhubung dengan kami melalui media sosial.</p>
                        <div class="contact-socials-large">
                            <a href="https://discord.gg/Mv3m7mtr" target="_blank" class="btn" style="background: #5865F2;">Join Discord</a>
                            <a href="https://www.tiktok.com/@pinewaioficial?_t=ZS-8yGrl19Ny4n&_r=1" target="_blank" class="btn" style="background: black;">TikTok</a>
                        </div>
                        <div class="contact-info-large">
                            <p><span class="material-symbols-outlined">call</span> +62 882-2670-5434</p>
                            <p><span class="material-symbols-outlined">email</span> bypaongpinew@gmail.com</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="calculator-view" class="view">
                <div class="app-container" style="padding: 20px;">
                     <header class="app-header" style="position: static; margin-bottom: 20px;">
                        <button class="back-btn" id="back-to-chat-from-calculator"><span class="material-symbols-outlined">arrow_back</span></button>
                        <h1 class="header-title">Kalkulator</h1>
                        <div style="width: 44px;"></div>
                    </header>
                    <div class="calculator-wrapper">
                        <div class="calculator-display-container">
                            <div id="calculator-expression" class="calculator-expression"></div>
                            <div id="calculator-current-input" class="calculator-current-input">0</div>
                        </div>
                        <div class="calculator-grid">
                            <button class="calc-btn operator">C</button><button class="calc-btn operator">%</button><button class="calc-btn operator">⌫</button><button class="calc-btn operator">÷</button>
                            <button class="calc-btn">7</button><button class="calc-btn">8</button><button class="calc-btn">9</button><button class="calc-btn operator">×</button>
                            <button class="calc-btn">4</button><button class="calc-btn">5</button><button class="calc-btn">6</button><button class="calc-btn operator">-</button>
                            <button class="calc-btn">1</button><button class="calc-btn">2</button><button class="calc-btn">3</button><button class="calc-btn operator">+</button>
                            <button class="calc-btn zero">0</button><button class="calc-btn">,</button><button class="calc-btn equals">=</button>
                        </div>
                        <div class="ai-calculator-section">
                            <h2 class="page-header" style="font-size: 20px; text-align: center;">Kalkulator AI Pintar</h2>
                            <p style="text-align: center; margin-bottom: 15px; color: var(--text-secondary);">Unggah gambar soal matematika Anda</p>
                            <button id="ai-calc-upload-btn" class="btn"><span class="material-symbols-outlined">photo_camera</span>Unggah Soal</button>
                            <input type="file" id="ai-calc-file-input" accept="image/*" style="display: none;">
                            <div id="ai-calculator-result" class="ai-calculator-result">Hasil analisis AI akan muncul di sini...</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const app = {};
        window.app = app;
        
        // --- API KEYS UPDATED ---
        const GEMINI_API_KEY = "AIzaSyAmD2ZIZDjs0LdqqRb77HjRFQyXtdyzeCw";
        const STABILITY_API_KEY = "sk-XJfxit1Yys7FDsNZJ4FdlXamz1qUrP6brjdp7ntzTEbDJY7Z";

        let currentChat = null;
        let uploadedImageBase64 = null;

        // --- REFACTORED AND SIMPLIFIED STORAGE ---
        const getStoredJSON = (key) => {
            const data = localStorage.getItem(key);
            try {
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error("Error parsing JSON from localStorage", e);
                return null;
            }
        };
        const saveStoredJSON = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving JSON to localStorage", e);
            }
        };


        function applyTheme(theme) {
            const themeBtn = document.getElementById('theme-toggle-btn');
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">light_mode</span>Mode Terang`;
            } else {
                document.body.classList.remove('dark-theme');
                if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">dark_mode</span>Mode Gelap`;
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('pi_new_theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('pi_new_theme', newTheme);
            applyTheme(newTheme);
        }

        // --- ROBUST VIEW NAVIGATION ---
        function navigate(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const viewElement = document.getElementById(viewId);
            if(viewElement) {
                viewElement.classList.add('active');
            }
            if (viewId === 'chat-view') {
                setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
            }
        }
        
        function streamMessage(messageElement, fullText) {
            const words = fullText.split(' ');
            let currentText = '';
            let wordIndex = 0;
            const interval = setInterval(() => {
                if (wordIndex < words.length) {
                    currentText += words[wordIndex] + ' ';
                    messageElement.innerHTML = currentText.replace(/\n/g, '<br>') + '▌';
                    wordIndex++;
                } else {
                    clearInterval(interval);
                    messageElement.innerHTML = fullText.replace(/\n/g, '<br>');
                }
            }, 50);
        }

        function addMessage(sender, content, type = 'text') {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            let messageContent = '';
            if (type === 'loading') {
                messageDiv.classList.add('loading-placeholder');
                messageContent = `<div class="spinner"></div><span>${content}</span>`;
            } else if (type === 'image') {
                messageContent = `<div class="message-content"><p>Berikut gambar yang Anda minta:</p><img src="${content}" alt="Generated by AI"><button class="btn download-btn" onclick="window.app.downloadImage('${content}', 'pi-new-image.png')"><span class="material-symbols-outlined">download</span> Download</button></div>`;
            } else if (type === 'code') {
                const lang = content.language;
                const code = content.code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                messageContent = `<div class="message-content">
                    <p>Berikut kode ${lang} yang Anda minta:</p>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">${lang}</span>
                            <button class="copy-code-btn" onclick="window.app.copyCode(this)">Copy</button>
                        </div>
                        <pre><code>${code}</code></pre>
                    </div>
                </div>`;
            } else {
                content = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
                messageContent = `<div class="message-content">${content}</div>`;
            }
            messageDiv.innerHTML = `<div class="message-header"><span class="material-symbols-outlined">${sender === 'user' ? 'person' : 'smart_toy'}</span><span>${sender === 'user' ? 'Anda' : 'P.I. New 2.0 Pro'}</span></div>` + messageContent;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        async function queryGemini(chatHistory, imageBase64 = null) {
            const model = 'gemini-1.5-flash-latest';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            const contents = chatHistory.map(msg => ({ role: msg.role === 'ai' ? 'model' : 'user', parts: [{ text: msg.content }] }));
            if (imageBase64) {
                const lastUserContent = contents[contents.length - 1];
                if (lastUserContent && lastUserContent.role === 'user') {
                    lastUserContent.parts.unshift({ inline_data: { mime_type: 'image/jpeg', data: imageBase64.split(',')[1] } });
                } else {
                    contents.push({ role: 'user', parts: [{ inline_data: { mime_type: 'image/jpeg', data: imageBase64.split(',')[1] } }] });
                }
            }
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents }) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'Unknown API error');
            }
            const data = await response.json();
            if (!data.candidates || data.candidates.length === 0) {
                throw new Error("API tidak memberikan respons. Mungkin karena filter keamanan.");
            }
            return data.candidates[0].content.parts[0].text;
        }

        async function generateImage(prompt) {
            const url = "https://api.stability.ai/v1/generation/stable-diffusion-v1-6/text-to-image";
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': `Bearer ${STABILITY_API_KEY}` },
                body: JSON.stringify({ text_prompts: [{ text: prompt }], cfg_scale: 7, height: 1024, width: 1024, steps: 30, samples: 1 }),
            });
            if (!response.ok) throw new Error(await response.text());
            const responseJSON = await response.json();
            return `data:image/png;base64,${responseJSON.artifacts[0].base64}`;
        }

        async function processUserInput() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (!prompt && !uploadedImageBase64) return;

            const userMessageText = prompt || (uploadedImageBase64 ? "Jelaskan gambar ini." : "");
            const userMessageContent = uploadedImageBase64 
                ? `<img src="${uploadedImageBase64}" alt="Uploaded image" class="user-upload-image"><p>${userMessageText}</p>`
                : userMessageText;
            
            addMessage('user', userMessageContent);
            saveMessageToHistory('user', userMessageText, 'text', userMessageContent);
            
            const loadingMessage = addMessage('ai', 'AI sedang berpikir...', 'loading');
            
            try {
                let response;
                if (prompt.startsWith('/gambar ')) {
                    loadingMessage.querySelector('span').textContent = 'Membuat gambar...';
                    const description = prompt.substring(8);
                    response = await generateImage(description);
                    loadingMessage.remove();
                    addMessage('ai', response, 'image');
                    saveMessageToHistory('ai', response, 'image');
                } else if (prompt.startsWith('/kode ')) {
                    loadingMessage.querySelector('span').textContent = 'Membuat kode...';
                    const parts = prompt.substring(6).split(' ');
                    const language = parts[0];
                    const idea = parts.slice(1).join(' ');
                    const codePrompt = `Buatlah sebuah cuplikan kode dalam bahasa ${language} untuk: ${idea}. Berikan hanya kode mentahnya tanpa penjelasan tambahan.`;
                    response = await queryGemini([{role: 'user', content: codePrompt}]);
                    loadingMessage.remove();
                    const codeData = { language, code: response };
                    addMessage('ai', codeData, 'code');
                    saveMessageToHistory('ai', JSON.stringify(codeData), 'code');
                } else {
                    const apiHistory = currentChat.messages
                        .filter(msg => msg.type !== 'image')
                        .map(m => ({
                            role: m.role,
                            content: m.apiContent
                        }));

                    response = await queryGemini(apiHistory, uploadedImageBase64);
                    loadingMessage.remove();
                    const aiMessageElement = addMessage('ai', '');
                    streamMessage(aiMessageElement.querySelector('.message-content'), response);
                    saveMessageToHistory('ai', response);
                }
            } catch (error) {
                console.error("API Error:", error);
                loadingMessage.remove();
                addMessage('ai', `Maaf, terjadi kesalahan: ${error.message}`);
                saveMessageToHistory('ai', `Error: ${error.message}`);
            } finally {
                resetImagePreview();
                input.value = '';
                input.style.height = 'auto';
            }
        }

        function saveMessageToHistory(sender, apiContent, type = 'text', displayContent = null) {
            if (!currentChat) return;
            const message = { 
                role: sender, 
                apiContent,
                displayContent: displayContent || apiContent,
                type
            };
            currentChat.messages.push(message);
            const allChats = getStoredJSON('pi_new_chatHistory') || [];
            const chatIndex = allChats.findIndex(c => c.id === currentChat.id);
            if (chatIndex > -1) {
                if (allChats[chatIndex].title === "Percakapan Baru" && sender === 'user') {
                    allChats[chatIndex].title = apiContent.substring(0, 30) + (apiContent.length > 30 ? '...' : '');
                }
                allChats[chatIndex].messages = currentChat.messages;
                saveStoredJSON('pi_new_chatHistory', allChats);
                document.getElementById('chat-title').textContent = allChats[chatIndex].title;
            }
        }

        function createNewChatAndShow() {
            const allChats = getStoredJSON('pi_new_chatHistory') || [];
            const newChat = { id: Date.now().toString(), title: "Percakapan Baru", messages: [] };
            allChats.unshift(newChat);
            saveStoredJSON('pi_new_chatHistory', allChats);
            app.loadChat(newChat.id);
        }

        function renderHistoryList() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            const allChats = getStoredJSON('pi_new_chatHistory') || [];
            if (allChats.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada riwayat.</p>';
                return;
            }
            allChats.forEach(chat => {
                const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].displayContent : 'Kosong';
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `<div class="history-title">${chat.title}</div><div class="history-preview">${lastMsg.replace(/<[^>]*>/g, '').substring(0,100)}</div><div class="history-actions"><button onclick="window.app.loadChat('${chat.id}')">Buka</button><button onclick="window.app.renameChat('${chat.id}')">Ganti Nama</button><button onclick="window.app.deleteChat('${chat.id}')" style="color:red;">Hapus</button></div>`;
                historyList.appendChild(historyItem);
            });
        }

        function setupCalculator() {
            const currentInputEl = document.getElementById('calculator-current-input');
            const expressionEl = document.getElementById('calculator-expression');
            const buttons = document.querySelectorAll('.calc-btn');
            
            let currentInput = '0';
            let expression = '';
            let lastWasOperator = false;

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.textContent;

                    if (!isNaN(value) || value === ',') {
                        if (currentInput === '0' && value !== ',') {
                            currentInput = value;
                        } else {
                            if (value === ',' && currentInput.includes(',')) return;
                            currentInput += value;
                        }
                        lastWasOperator = false;
                    } else if (['+', '-', '×', '÷'].includes(value)) {
                        if (lastWasOperator) {
                             expression = expression.slice(0, -2) + ` ${value} `;
                        } else {
                            expression += `${currentInput.replace(',', '.')} ${value} `;
                        }
                        currentInput = '0';
                        lastWasOperator = true;
                    } else if (value === '%') {
                        currentInput = String(parseFloat(currentInput.replace(',', '.')) / 100).replace('.', ',');
                    } else if (value === '⌫') {
                        currentInput = currentInput.slice(0, -1) || '0';
                    } else if (value === 'C') {
                        currentInput = '0';
                        expression = '';
                        lastWasOperator = false;
                    } else if (value === '=') {
                        if (expression && !lastWasOperator) {
                             expression += currentInput.replace(',', '.');
                             try {
                                 let evalExpression = expression.replace(/×/g, '*').replace(/÷/g, '/');
                                 currentInput = String(eval(evalExpression)).replace('.', ',');
                             } catch {
                                 currentInput = 'Error';
                             }
                             expression = '';
                             lastWasOperator = false;
                        }
                    }
                    updateDisplay();
                });
            });

            function updateDisplay() {
                currentInputEl.textContent = currentInput;
                expressionEl.textContent = expression.replace(/\*/g, '×').replace(/\//g, '÷');
            }
        }
        
        async function handleAiCalculatorUpload(file) {
            const resultDiv = document.getElementById('ai-calculator-result');
            resultDiv.innerHTML = '<div class="spinner" style="margin: 0 auto;"></div><p style="text-align:center;">Menganalisis gambar...</p>';
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageBase64 = e.target.result;
                try {
                    const prompt = "Anda adalah seorang ahli matematika. Analisis gambar ini, identifikasi soal matematika di dalamnya, dan berikan jawaban beserta langkah-langkah dan rumus yang digunakan untuk menyelesaikannya.";
                    const response = await queryGemini([{ role: 'user', content: prompt }], imageBase64);
                    resultDiv.innerHTML = response.replace(/\n/g, '<br>');
                } catch (error) {
                    console.error("AI Calculator Error:", error);
                    resultDiv.textContent = `Gagal menganalisis gambar: ${error.message}`;
                }
            };
            reader.readAsDataURL(file);
        }

        app.loadChat = (chatId) => {
            const chatToLoad = (getStoredJSON('pi_new_chatHistory') || []).find(c => c.id === chatId);
            if (chatToLoad) {
                currentChat = chatToLoad;
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                if(currentChat.messages.length === 0){
                        const welcomeMsg = 'Halo! Saya P.I. New 2.0 Pro. Ada yang bisa saya bantu?';
                        addMessage('ai', welcomeMsg);
                        saveMessageToHistory('ai', welcomeMsg, 'text', welcomeMsg);
                } else {
                    currentChat.messages.forEach(msg => addMessage(msg.role, msg.displayContent, msg.type));
                }
                document.getElementById('chat-title').textContent = currentChat.title;
                navigate('chat-view');
            }
        };
        app.renameChat = (chatId) => {
            const newTitle = prompt('Masukkan judul baru:');
            if (newTitle && newTitle.trim()) {
                const allChats = getStoredJSON('pi_new_chatHistory') || [];
                const chatIndex = allChats.findIndex(c => c.id === chatId);
                if (chatIndex > -1) {
                    allChats[chatIndex].title = newTitle.trim();
                    saveStoredJSON('pi_new_chatHistory', allChats);
                    renderHistoryList();
                    if (currentChat && currentChat.id === chatId) {
                        document.getElementById('chat-title').textContent = newTitle.trim();
                    }
                }
            }
        };
        app.deleteChat = (chatId) => {
            if (confirm('Yakin ingin menghapus percakapan ini?')) {
                let allChats = getStoredJSON('pi_new_chatHistory') || [];
                saveStoredJSON('pi_new_chatHistory', allChats.filter(c => c.id !== chatId));
                renderHistoryList();
                if (currentChat && currentChat.id === chatId) {
                    const latestChats = getStoredJSON('pi_new_chatHistory') || [];
                    if (latestChats.length > 0) app.loadChat(latestChats[0].id);
                    else createNewChatAndShow();
                }
            }
        };
        app.downloadImage = async (url, filename) => {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (e) { window.open(url, '_blank'); }
        };
        app.copyCode = (button) => {
            const code = button.closest('.code-block').querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                button.innerText = 'Tersalin!';
                setTimeout(() => button.innerText = 'Copy', 2000);
            });
        };
        
        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageBase64 = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function resetImagePreview() {
            uploadedImageBase64 = null;
            document.getElementById('file-input').value = '';
        }

        function handleLogin(e) {
            e.preventDefault();
            const users = getStoredJSON('pi_new_users') || {};
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            // Simple password check (in a real app, use hashing!)
            if (users[username] && users[username].password === password) {
                localStorage.setItem('pi_new_currentUser', username);
                initializeAppLogic();
            } else {
                document.getElementById('login-error').textContent = 'Username atau password salah!';
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const users = getStoredJSON('pi_new_users') || {};
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            const errorEl = document.getElementById('register-error');

            if (users[username]) { errorEl.textContent = 'Username sudah digunakan!'; return; }
            if (password.length < 6) { errorEl.textContent = 'Password minimal 6 karakter!'; return; }
            if (password !== confirm) { errorEl.textContent = 'Password tidak cocok!'; return; }
            
            const proceed = () => {
                users[username] = { password: password }; // Store plain for this example
                saveStoredJSON('pi_new_users', users);
                localStorage.setItem('pi_new_currentUser', username);
                initializeAppLogic();
            };

            if (!getStoredJSON('pi_new_storage_consent')) {
                showStorageConsentModal(proceed);
            } else {
                proceed();
            }
        }

        function handleLogout() {
            localStorage.removeItem('pi_new_currentUser');
            currentChat = null;
            navigate('login-view');
        }

        function showModal(title, content, footerContent = '') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            const modalFooter = document.getElementById('modal-footer');
            modalFooter.innerHTML = footerContent;
            document.getElementById('modal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function showStorageConsentModal(callback) {
            const title = "Pemberitahuan Privasi & Penyimpanan";
            const content = "<p>Aplikasi ini akan menyimpan data akun dan riwayat percakapan Anda di penyimpanan lokal (localStorage) pada perangkat ini. Data ini tidak dikirim ke server dan hanya dapat diakses dari browser Anda.</p><p>Dengan melanjutkan, Anda setuju dengan penyimpanan data ini.</p>";
            const footer = '<button id="consent-btn" class="btn">Saya Mengerti & Lanjutkan</button>';
            showModal(title, content, footer);
            document.getElementById('consent-btn').onclick = () => {
                saveStoredJSON('pi_new_storage_consent', true);
                hideModal();
                callback();
            };
            document.getElementById('modal-close-btn').style.display = 'none';
        }

        function initializeAppLogic() {
            const currentUser = localStorage.getItem('pi_new_currentUser');
            if (currentUser) {
                const allChats = getStoredJSON('pi_new_chatHistory') || [];
                if (allChats.length > 0) {
                    app.loadChat(allChats[0].id);
                } else {
                    createNewChatAndShow();
                }
            } else {
                navigate('login-view');
            }
        }

        function initEventListeners() {
            document.getElementById('menu-calculator-btn').addEventListener('click', () => navigate('calculator-view'));
            document.getElementById('back-to-chat-from-calculator').addEventListener('click', () => navigate('chat-view'));
            
            setupCalculator();
            document.getElementById('ai-calc-upload-btn').addEventListener('click', () => document.getElementById('ai-calc-file-input').click());
            document.getElementById('ai-calc-file-input').addEventListener('change', e => { if (e.target.files[0]) handleAiCalculatorUpload(e.target.files[0]); });
            
            const menuBtn = document.getElementById('hamburger-btn');
            const overlay = document.getElementById('overlay');
            const menuLinks = document.querySelectorAll('#sidebar-menu a');
            menuBtn.addEventListener('click', () => document.body.classList.toggle('menu-open'));
            overlay.addEventListener('click', () => document.body.classList.remove('menu-open'));
            menuLinks.forEach(el => el.addEventListener('click', () => document.body.classList.remove('menu-open')));
            
            document.getElementById('menu-new-chat-btn').addEventListener('click', createNewChatAndShow);
            document.getElementById('menu-history-btn').addEventListener('click', () => { renderHistoryList(); navigate('history-view'); });
            document.getElementById('menu-contact-btn').addEventListener('click', () => navigate('contact-view'));
            document.getElementById('menu-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
            
            document.getElementById('go-to-register-btn').addEventListener('click', () => navigate('register-view'));
            document.getElementById('go-to-login-btn').addEventListener('click', () => navigate('login-view'));
            document.getElementById('back-to-chat-from-history').addEventListener('click', () => navigate('chat-view'));
            document.getElementById('back-to-chat-from-contact').addEventListener('click', () => navigate('chat-view'));
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            
            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', processUserInput);
            chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processUserInput(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = `${chatInput.scrollHeight}px`; });
            
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', e => { if (e.target.files[0]) handleImageUpload(e.target.files[0]); });
            
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
            
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const input = toggle.previousElementSibling;
                    const isVisible = input.type === 'text';
                    input.type = isVisible ? 'password' : 'text';
                    toggle.textContent = isVisible ? 'visibility_off' : 'visibility';
                });
            });
        }
        
        // --- FINAL APP STARTUP ---
        function startApp() {
            const savedTheme = localStorage.getItem('pi_new_theme') || 'light';
            applyTheme(savedTheme);
            initEventListeners();

            // Show loading screen for a short, fixed period for aesthetics
            setTimeout(() => {
                initializeAppLogic();
            }, 2000); // 2-second loading screen
        }

        startApp();
    });
    </script>
</body>
</html>

